<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BusTrackSV — Ruta</title>
  <link rel="icon" href="/assets/img/logo-bus.png">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
</head>
<body>
  <div id="appHeader"></div>

  <main class="layout">
    <section class="card pad">
      <div class="row space">
        <h2 class="h" id="routeTitle">Ruta</h2>
        <div class="row" style="gap:.5rem">
          <span class="pill ok">Activos: <span id="countActive">0</span></span>
          <span class="pill bad">Inactivos: <span id="countInactive">0</span></span>
          <button class="btn" id="btnEdit">Editar</button>
          <button class="btn" id="btnAddTeam">Añadir nuevo equipo</button>
        </div>
      </div>

      <div class="card" style="overflow:auto">
        <table class="table" id="teamsTable">
          <thead>
            <tr><th>Equipo</th><th>Chofer</th><th>Teléfono</th><th>Estado</th><th style="width:160px"></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="stack" style="margin-top:1rem">
        <label class="label">Cargar CSV de ruta (lat,lon) o (id,lat,lon)</label>
        <input id="csvInput" type="file" accept=".csv">
      </div>

      <div id="map" style="height:420px; margin-top:1rem; border-radius:12px; border:1px solid var(--ring)"></div>
    </section>
  </main>

  <div id="appFooter"></div>

  <!-- Modal Añadir equipo -->
  <div class="modal" id="modalTeam">
    <div class="panel card pad">
      <div class="row space"><div class="h">Añadir nuevo equipo</div><button class="btn ghost" onclick="document.getElementById('modalTeam').classList.remove('open')">Cerrar</button></div>
      <form id="formTeam" class="stack">
        <div><label class="label">Nombre del equipo</label><input class="input" id="tName" placeholder="Equipo X"></div>
        <div><label class="label">Nombre del Chofer</label><input class="input" id="tDriver" placeholder="—"></div>
        <div><label class="label">Número de teléfono del chofer</label><input class="input" id="tPhone" placeholder="—"></div>
        <div class="row"><button class="btn ok" type="submit">Guardar cambios</button><button class="btn muted" type="button" onclick="document.getElementById('modalTeam').classList.remove('open')">Cancelar</button></div>
      </form>
    </div>
  </div>

  <!-- Confirm -->
  <div class="modal" id="modalConfirm">
    <div class="panel card pad">
      <div class="h" id="confirmText">¿Seguro?</div>
      <div class="row" style="margin-top:.8rem">
        <button class="btn danger" id="confirmYes">Eliminar</button>
        <button class="btn muted" id="confirmNo">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="toast-wrap"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script type="module">
    import { renderHeader, renderFooter } from "../assets/js/components.js";
    import { toast, $, $$, openModal } from "../assets/js/ui.js";
    import { api } from "../assets/js/api.js";
    import { storage } from "../assets/js/storage.js";

    if(!storage.token) location.href='./login.html';
    renderHeader({back:'./dashboard.html', logout:true}); renderFooter();

    const params = new URLSearchParams(location.search);
    const routeId = Number(params.get('id') || 0);

    const map = L.map('map').setView([13.69294, -89.21819], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

    let routeData = null;
    let editMode = false;
    let pendingTeamId = null;

    const pencil = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>`;
    const trash  = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;

    async function refresh(){
      routeData = await api.getRouteDetail(routeId);
      $('#routeTitle').textContent = routeData.name;
      $('#countActive').textContent = routeData.active||0;
      $('#countInactive').textContent = routeData.inactive||0;

      const tb = $('#teamsTable tbody');
      tb.innerHTML = (routeData.teams||[]).map(t=>`
        <tr data-id="${t.id}">
          <td>${t.name}</td>
          <td>
            <span>${t.driver||"—"}</span>
            ${editMode? `<button class="icon-btn sm" data-edit="driver" title="Editar chofer">${pencil}</button>` : ``}
          </td>
          <td>
            <span>${t.phone||"—"}</span>
            ${editMode? `<button class="icon-btn sm" data-edit="phone" title="Editar teléfono">${pencil}</button>` : ``}
          </td>
          <td>
            <button class="btn ${t.active?'ok':'muted'} toggle" data-id="${t.id}">${t.active?'Activo':'Inactivo'}</button>
          </td>
          <td>
            ${editMode? `<button class="btn danger" data-del="${t.id}">${trash} Eliminar</button>` : ``}
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="muted">Aún no hay equipos</td></tr>';

      // Toggle activo/inactivo
      $$('#teamsTable .toggle').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const id = Number(b.dataset.id);
          const to = !(b.textContent.trim()==='Activo');
          await api.toggleTeam(routeId, id, to);
          refresh();
        });
      });

      // Edit (lapicito)
      $$('#teamsTable [data-edit]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const tr = btn.closest('tr');
          const teamId = Number(tr.dataset.id);
          const field = btn.getAttribute('data-edit'); // 'driver' | 'phone'
          const current = tr.querySelector(field==='driver' ? 'td:nth-child(2) span' : 'td:nth-child(3) span').textContent.trim();
          const val = prompt(`Nuevo ${field==='driver'?'chofer':'teléfono'}:`, current);
          if(val===null) return;
          await api.updateTeam(routeId, teamId, field==='driver'? {driver: val} : {phone: val});
          toast('Datos actualizados','ok');
          refresh();
        });
      });

      // Delete team
      $$('#teamsTable [data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          pendingTeamId = Number(btn.getAttribute('data-del'));
          document.getElementById('confirmText').textContent = '¿Eliminar este equipo?';
          openModal('modalConfirm');
        });
      });
    }

    // Botón Editar con estado visual
    const btnEdit = document.getElementById('btnEdit');
    btnEdit.addEventListener('click', ()=>{
      editMode = !editMode;
      if(editMode){
        btnEdit.classList.add('toggled');
        btnEdit.textContent = 'Editando';
      }else{
        btnEdit.classList.remove('toggled');
        btnEdit.textContent = 'Editar';
      }
      refresh();
    });

    // Añadir equipo
    document.getElementById('btnAddTeam').addEventListener('click',()=> openModal('modalTeam'));
    document.getElementById('formTeam').addEventListener('submit', async(e)=>{
      e.preventDefault();
      await api.addTeam(routeId, { name: $('#tName').value.trim() || undefined, driver: $('#tDriver').value.trim(), phone: $('#tPhone').value.trim() });
      toast('Equipo agregado','ok'); document.getElementById('modalTeam').classList.remove('open'); refresh();
      $('#tName').value=''; $('#tDriver').value=''; $('#tPhone').value='';
    });

    // Confirm delete team
    document.getElementById('confirmNo').addEventListener('click', ()=> document.getElementById('modalConfirm').classList.remove('open'));
    document.getElementById('confirmYes').addEventListener('click', async ()=>{
      if(pendingTeamId){
        await api.deleteTeam(routeId, pendingTeamId).catch(()=>toast('No se pudo eliminar','bad'));
        pendingTeamId = null;
        document.getElementById('modalConfirm').classList.remove('open');
        toast('Equipo eliminado','ok'); refresh();
      }
    });

    // CSV
    document.getElementById('csvInput').addEventListener('change', e=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        const lines = String(fr.result).trim().split("\n");
        const pts = [];
        for(let i=1;i<lines.length;i++){
          const c = lines[i].split(",").map(s=>s.trim());
          let lat = parseFloat(c[0]), lon = parseFloat(c[1]);
          if(Number.isNaN(lat) || Number.isNaN(lon)){ lat = parseFloat(c[1]); lon = parseFloat(c[2]); }
          if(!Number.isNaN(lat) && !Number.isNaN(lon)) pts.push([lat,lon]);
        }
        if(pts.length){ L.polyline(pts).addTo(map); map.fitBounds(pts); toast("Ruta cargada desde CSV","ok"); }
        else{ toast("CSV sin puntos válidos","bad"); }
      };
      fr.readAsText(f);
    });

    refresh();
  </script>
</body>
</html>
